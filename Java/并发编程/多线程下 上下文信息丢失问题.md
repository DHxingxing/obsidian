 在 Java 并发编程中，认证信息、用户上下文、traceId 等常通过 `ThreadLocal` 存储在主线程。但当任务切换到异步线程、线程池、Disruptor 或 Redis Stream 等环境时，`ThreadLocal` 数据不会自动传递，导致认证失败、日志丢链等问题。

目前遇到的问题是，用户的session信息在异步的Redis中Stream中无法拿到Spring web管理的上下文信息。使其无法调用feign。

####  线程上下文不共享的原因

- `ThreadLocal` 是线程私有的，不能自动在线程间传播。
    
- 异步线程或线程池复用线程拿不到主线程的上下文信息。
    

| 方式                            | 简述                           | 适用场景       |
| ----------------------------- | ---------------------------- | ---------- |
| TransmittableThreadLocal（TTL） | 自动透传 `ThreadLocal` 到线程池/异步线程 | 高并发系统、异步场景 |
| Nacos + 系统级Session            | 禁止🈲                         | 不安全，存在泄漏漏洞 |
|                               |                              |            |
|                               |                              |            |
目前项目中使用的是 将接口放在了开放接口下，避免了Session认证

---

- 高并发场景（如线程池、Disruptor）：引入 [TTL](https://github.com/alibaba/transmittable-thread-local) 实现上下文透传
    

---
