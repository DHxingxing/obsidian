当标注任务的人员发生变化时候，需要处理已分配资源的重新分配
分为两种情况：
#### - 打回前判断：如果这里人员被删除了，那么我们打回他的资源的时候要把打回的资源打回到公共资源池中。

- **触发**：审核员或验收员点击“打回”按钮。
    
- **系统检查**：
    
    - 获取当前任务的负责人 `operate_user_id`。
        
    - 在用户表中校验 `operate_user_id` 是否有效（未被删除、未被禁用等）。
        
- **如果用户有效** ：
```txt
	当前状态 → 打回后状态
	MARKING → BACK (标注员被打回)
	MARKED → BACK (标注员被打回)
	CHECKING → BACK (检查员被打回)
	CHECKED → BACK (检查员被打回)
	ACCEPTING → BACK (验收员被打回)
```

 - **如果用户无效**：任务状态从 `ASSIGNED` -> `IN_POOL`，并清空负责人信息。

```txt
		当前状态 → 打回后状态
	MARKING → WAIT_MARK (标注员无效，进入标注资源池)
	MARKED → WAIT_MARK (标注员无效，进入标注资源池)
	CHECKING → WAIT_CHECK (检查员无效，进入检查资源池)
	CHECKED → WAIT_CHECK (检查员无效，进入检查资源池)
	ACCEPTING → WAIT_ACCEPT (验收员无效，进入验收资源池)
```

#### 打回后检查：如果被删除的人手上有被打回的资源，那么我们把这些资源送到竞争资源池子里

获取竞争资源的也要把打回没有操作人的资源 也要纳入，这不就相当于打回的资源在公共资源池里了

---


**技术选型**：推荐使用**状态机**来管理和控制整个流程，这能让任务状态的流转更加清晰和健壮。

## 新概念： 什么是状态机？
```text

状态机就是一个数学模型，他定义了一种状态到另一种状态转变时的条件、动作。在Java代码中就是通过这种

A --条件--> B 模型映射到代码来代替if - else

```
---

举个例子：

在电商平台中，一个订单会有多种状态，临时单、已下单、待支付、已支付、待发货、待收货、已完成等等。每一种状态都和变化前的状态以及执行的操作有关。

比如，用户将商品加入购物车后，后台会生成一个所谓的“临时单”。因为用户还没有点击下单，所以这个订单实际上还没有生成。只有当用户下单后，这个“临时单”才会转化为一个“待支付的订单”。

以上过程中只有将一个处于“临时单”状态的订单执行下单操作，才能得到一个状态为“待支付”的订单。 即一个前置状态+一个恰当的操作，才能流转订单的状态。在这个过程中如果使用硬编码，我们就需要一系列的 if-else 语句来检查订单的当前状态、可执行操作以及这两个组合得到的下一个应该被流转的状态值。如果订单的状态流转很复杂，代码逻辑就会很复杂，可读性低，后期维护困难。

处理以上问题，我们可以使用状态设计模式来处理。对应到实践，就是状态机。

---
### 下面给出状态机的四大概念：

- 第一个是 State ，状态。一个状态机至少要包含两个状态。例如上面自动门的例子，有 open 和 closed 两个状态。
- 第二个是 Event ，事件。事件就是执行某个操作的触发条件或者口令。对于自动门，“按下开门按钮”就是一个事件。
- 第三个是 Action ，动作。事件发生以后要执行动作。例如事件是“按开门按钮”，动作是“开门”。编程的时候，一个 Action一般就对应一个函数。
- 第四个是 Transition ，变换。也就是从一个状态变化为另一个状态。例如“开门过程”就是一个变换

## 如何设计状态机？

当我们设计状态机的时候，我们要确定需求的六种元素：起始、终止、现态、次态（目标状态）、动作、条件

以订单为例：以从待支付状态转换为待发货状态为例:
起始状态：订单创建好后处于待支付
- ①现态：是指当前所处的状态。待支付
- ②条件：又称为“事件”，当一个条件被满足，将会触发一个动作，或者执行一次状态的迁移。支付事件
- ③动作：条件满足后执行的动作。动作执行完毕后，可以迁移到新的状态，也可以仍旧保持原状态。动作不是必需的，当条件满足后，也可以不执行任何动作，直接迁移到新状态。状态转换为待发货
- ④次态：条件满足后要迁往的新状态。“次态”是相对于“现态”而言的，“次态”一旦被激活，就转变成新的“现态”了。待发货
终止状态：订单完成、订单取消、超时关闭、退款成功等

注意事项

1、避免把某个“程序动作”当作是一种“状态”来处理。那么如何区分“动作”和“状态”？“动作”是不稳定的，即使没有条件的触发，**“动作”一旦执行完毕就结束了**；**而“状态”是相对稳定的，如果没有外部条件的触发，一个状态会一直持续下去**。

2、状态划分时漏掉一些状态，导致跳转逻辑不完整。所以在设计状态机时，我们需要反复的查看设计的状态图或者状态表，最终达到一种牢不可破的设计方案。

### Spring为我们提供了状态机 ---- spring statemachine

Spring Statemachine旨在提供以下功能：(看不懂)

1. 易于使用的扁平单级状态机，用于简单的使用案例。
2. 分层状态机结构，以简化复杂的状态配置。
3. 状态机区域提供更复杂的状态配置。
4. 使用触发器，转换，警卫和操作。
5. 键入安全配置适配器。
6. 生成器模式，用于在Spring Application上下文之外使用的简单实例化通常用例的食谱
7. 基于Zookeeper的分布式状态机
8. 状态机事件监听器。
9. UML Eclipse Papyrus建模。
10. 将计算机配置存储在永久存储中。
11. Spring IOC集成将bean与状态机关联起来。

