<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Iflytek/技术方案/Ai大模型调用时候Redission实现的令牌桶限流" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Ai大模型调用时候Redission实现的令牌桶限流 | 不百科</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://DHxingxing.github.io/obsidian/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://DHxingxing.github.io/obsidian/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://DHxingxing.github.io/obsidian/docs/Iflytek/技术方案/Ai大模型调用时候Redission实现的令牌桶限流"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Ai大模型调用时候Redission实现的令牌桶限流 | 不百科"><meta data-rh="true" name="description" content="刚接到这个需求的时候，说实话，我对“令牌桶”的理解还停留在八股文的层面；至于调用大模型的方式，也只知道用 curl 敲命令行那一套。当我打开老项目的那一刻，眼前的画风简直是“代码地狱”：HTTP 请求头、请求体乱作一团，SSE 协议像是谜语人写的，WebSocket 配置更是云里雾里，简直要了我的老命。"><meta data-rh="true" property="og:description" content="刚接到这个需求的时候，说实话，我对“令牌桶”的理解还停留在八股文的层面；至于调用大模型的方式，也只知道用 curl 敲命令行那一套。当我打开老项目的那一刻，眼前的画风简直是“代码地狱”：HTTP 请求头、请求体乱作一团，SSE 协议像是谜语人写的，WebSocket 配置更是云里雾里，简直要了我的老命。"><link data-rh="true" rel="icon" href="/obsidian/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://DHxingxing.github.io/obsidian/docs/Iflytek/技术方案/Ai大模型调用时候Redission实现的令牌桶限流"><link data-rh="true" rel="alternate" href="https://DHxingxing.github.io/obsidian/docs/Iflytek/技术方案/Ai大模型调用时候Redission实现的令牌桶限流" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://DHxingxing.github.io/obsidian/docs/Iflytek/技术方案/Ai大模型调用时候Redission实现的令牌桶限流" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Ai大模型调用时候Redission实现的令牌桶限流","item":"https://DHxingxing.github.io/obsidian/docs/Iflytek/技术方案/Ai大模型调用时候Redission实现的令牌桶限流"}]}</script><link rel="alternate" type="application/rss+xml" href="/obsidian/blog/rss.xml" title="不百科 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/obsidian/blog/atom.xml" title="不百科 Atom Feed"><link rel="stylesheet" href="/obsidian/assets/css/styles.3a069d1d.css">
<script src="/obsidian/assets/js/runtime~main.36d71063.js" defer="defer"></script>
<script src="/obsidian/assets/js/main.21469662.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/obsidian/img/logo.svg"><div style="height:3px;background-color:var(--ifm-color-primary);width:0%;position:fixed;top:0;left:0;z-index:9999;transition:width 0.1s ease-out"></div><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/obsidian/"><div class="navbar__logo"><img src="/obsidian/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/obsidian/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">不百科</b></a><a class="navbar__item navbar__link" href="/obsidian/docs/intro">文档</a><a class="navbar__item navbar__link" href="/obsidian/blog">博客</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/DHxingxing/obsidian" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Meta+k)" aria-keyshortcuts="Meta+k"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/obsidian/docs/Iflytek/工作计划">Iflytek</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/工作计划">工作计划</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/Ai大模型调用时候Redission实现的令牌桶限流">技术方案</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/Ai大模型调用时候Redission实现的令牌桶限流">Ai大模型调用时候Redission实现的令牌桶限流</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/Java通过WebSocket 与AI进行通信">Java通过WebSocket 与AI进行通信</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/Result 包装响应体">Result 包装响应体</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/Spring Boot 中多环境异构配置的优雅实现">Spring Boot 中多环境异构配置的优雅实现</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/Zset做的延迟队列">Zset做的延迟队列</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/【最佳实践】Feign 泛型反序列化：告别 LinkedTreeMap 的终极解决方案">【最佳实践】Feign 泛型反序列化：告别 LinkedTreeMap 的终极解决方案</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/为什么await()会阻塞当前线程，在响应式环境中会导致线程匮乏？">为什么await()会阻塞当前线程，在响应式环境中会导致线程匮乏？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/再有人问你如何实现订单到期关闭，就把这篇文章发给他！">再有人问你如何实现订单到期关闭，就把这篇文章发给他！</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/动态sql拼接null 导致的错误">动态sql拼接null 导致的错误</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/多线程下 上下文信息丢失问题">多线程下 上下文信息丢失问题</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/异步资源导入架构设计说明">异步资源导入架构设计说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/数据库动态sql拼接问题！todo">数据库动态sql拼接问题！todo</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/竞态条件与 TTL 过期">竞态条件与 TTL 过期</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/编写yml导致的参数增删如何影响实体类呢？">动态 YAML → ModelParams 映射全链路揭秘与最佳实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/计算批次大小的证明">计算批次大小的证明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/重写Ai模块代码到新标注工具系统">重写Ai模块代码到新标注工具系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/技术方案/雪花算法导致的前端精度丢失问题">雪花算法导致的前端精度丢失问题</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/本周代办">本周代办</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/obsidian/docs/Iflytek/检查bug提示词：">检查bug提示词：</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/obsidian/docs/Java/AI/Rag">Java</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/obsidian/docs/daily/2025-06-30">daily</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/obsidian/docs/intro">我的知识库计划</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/obsidian/docs/未命名">未命名</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/obsidian/docs/源码/Redission 下的雪花算法">源码</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/obsidian/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Iflytek</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">技术方案</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Ai大模型调用时候Redission实现的令牌桶限流</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Ai大模型调用时候Redission实现的令牌桶限流</h1></header><p>刚接到这个需求的时候，说实话，我对“令牌桶”的理解还停留在八股文的层面；至于调用大模型的方式，也只知道用 <code>curl</code> 敲命令行那一套。当我打开老项目的那一刻，眼前的画风简直是“代码地狱”：HTTP 请求头、请求体乱作一团，SSE 协议像是谜语人写的，WebSocket 配置更是云里雾里，简直要了我的老命。</p>
<p>幸好有几位哥们在关键时刻伸出援手，总算把需求给撸顺了。但事后回头想想，这事让我彻底明白了那句老话：<strong>“学而不思则罔，思而不学则殆。”</strong> 如果只是为了交付而写代码，不去深究背后的原理，那开发工作也就和拧螺丝没啥本质区别 —— 差不多就是个工具人罢了。</p>
<p>所以，这次需求虽然一度让我抓耳挠腮，但也正是这份“痛苦”，让我意识到：<strong>光会调用 API，不懂协议和原理，是走不远的。</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1策略工厂替换原来的名称匹配">1、策略工厂替换原来的名称匹配<a href="#1策略工厂替换原来的名称匹配" class="hash-link" aria-label="1、策略工厂替换原来的名称匹配的直接链接" title="1、策略工厂替换原来的名称匹配的直接链接">​</a></h2>
<p>我们要接入多个模型，就要实现多个配置类，老项目中面对多种模型的选择时候使用的竟然是（&quot;中海油-海能大模型&quot;.equals(aiModelReq.getProjectAiModelConfigRequest().getModelName()),“大哥，你就拿名字和if-else 来做匹配啊，这真是想到什么写什么啊”)，因为每个模型的名字不一样，所以面对多个模型很自然的想到策略-工厂模式,不同的AI模型实现被封装在各自的策略类（<code>AiModelStragety</code>）中，<code>Service</code>层代码不需要关心具体模型的调用细节。这使得系统扩展性极强，增加新模型对现有代码无影响。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2redission-实现令牌桶限流">2、Redission 实现令牌桶限流<a href="#2redission-实现令牌桶限流" class="hash-link" aria-label="2、Redission 实现令牌桶限流的直接链接" title="2、Redission 实现令牌桶限流的直接链接">​</a></h2>
<p>目前的服务肯定是在微服务的多机器上的，你肯定不能用基于JVM的令牌桶来做。目前项目中能满足的就是Redis了，所以我们用Redis 来做令牌桶。(这个问题其实就是有人会问你为什么不自己手写一个令牌桶算法，我在下面放个表格对比下就知道了。)</p>
<table><thead><tr><th>特性</th><th>Redisson RSemaphore / RRateLimiter (令牌桶)</th><th>自己手写一个限流器 (如 Java 的 Semaphore)</th></tr></thead><tbody><tr><td>场景</td><td>分布式系统（多台服务器）</td><td>单机环境（只有一台服务器）</td></tr><tr><td>工作原理</td><td>所有实例共享 Redis 中的计数器，全局可见</td><td>每个实例各自维护内存中的计数器，彼此不知</td></tr><tr><td>一致性</td><td>强一致性，全局统一限流</td><td>无一致性，需要人为拆分额度，无法精准控制</td></tr><tr><td>可靠性</td><td>高：Redisson 使用 Lua 脚本保证原子性，稳定可靠</td><td>低：自己实现需要处理复杂分布式问题，容易出错</td></tr><tr><td>实现复杂度</td><td>极低：封装完善，一行代码搞定</td><td>极高：需设计数据结构、编写 Lua 脚本等</td></tr><tr><td>维护成本</td><td>低：由 Redisson 官方持续维护</td><td>高：自己写的逻辑需自己长期维护</td></tr></tbody></table>
<p>起初我采用的是<strong>滑动窗口限流</strong>策略，设定例如“1 分钟内最多允许 10 个请求”这样的阈值。但在实际运行中，我发现它并不适合我们当前的业务需求，尤其是在大模型调用这种<strong>请求耗时和资源消耗高度不均</strong>的场景下，暴露出明显问题：</p>
<ol>
<li>
<p><strong>不能体现任务的资源消耗差异</strong><br>
<!-- -->大模型的调用耗时和资源占用与任务本身紧密相关。例如，让模型生成一篇 1 万字的小说和回答一个 “1 + 1 = ?” 所需的计算量完全不同。滑动窗口只是简单统计单位时间内的<strong>请求次数</strong>，无法感知请求的复杂度和对系统资源的实际占用。结果就是：轻量任务也会消耗掉限流额度，重任务可能被积压，从而导致系统资源利用率低甚至<strong>出现等待但资源空闲</strong>的情况。</p>
</li>
<li>
<p><strong>存在“突刺流量”风险，影响系统稳定性</strong><br>
<!-- -->滑动窗口的另一个问题在于边界切换时的突刺效应。比如我们设置“1 分钟最多处理 5 个请求”：</p>
<ul>
<li>
<p>第 59 秒之前没有任何请求；</p>
</li>
<li>
<p>第 60 秒瞬间来了 5 个请求，被全部放行；</p>
</li>
<li>
<p>第 61 秒窗口滑动，又来了 5 个请求，同样被放行；</p>
</li>
</ul>
<p>结果是：在 2 秒内处理了 10 个请求，<strong>限流规则形同虚设</strong>，系统仍可能遭遇过载甚至被击穿。</p>
</li>
</ol>
<p>综上所述，滑动窗口限流在大模型任务调度场景下显得不够灵活，既无法感知真实负载，也容易因为流量突刺造成风险。因此，我倾向于改用更适合此类场景的限流策略，比如<strong>令牌桶算法</strong>，它能更好地平滑请求速率，并允许一定程度的突发流量，同时也更易于与任务队列、动态信号量等资源感知型机制结合，实现更细粒度的调度控制。</p>
<p>我放弃了滑动窗口改使用信号量方案来实现令牌桶。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 获取分布式信号量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">RSemaphore</span><span class="token plain"> semaphore </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> redissonClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSemaphore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">limiterKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<ul>
<li>Redis数据结构：使用Redis的String类型存储信号量的许可数量</li>
<li>原子操作：基于Redis的DECR和INCR命令实现原子性的获取和释放</li>
<li>分布式一致性：通过Redis的原子操作保证多实例间的数据一致性</li>
</ul>
<p>底层的实现可以分为初始化许可、获取许可、释放许可三步，三步是基于lua脚本操作的</p>
<p>想象一下，Redis 就是一个所有服务实例（你的应用部署在多个服务器上）都能访问的<strong>中央数据中心</strong>。Redisson 的所有操作，本质上都是在操作这个数据中心里的数据。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-初始化许可-trysetpermits">1. 初始化许可 (<code>trySetPermits</code>)<a href="#1-初始化许可-trysetpermits" class="hash-link" aria-label="1-初始化许可-trysetpermits的直接链接" title="1-初始化许可-trysetpermits的直接链接">​</a></h4>
<p>当你第一次为某个模型（比如 <code>gpt-4</code>）设置限流时，会调用 <code>semaphore.trySetPermits(5)</code>。</p>
<ul>
<li>
<p><strong>开发者意图</strong>：我想创建一个名为 <code>ai:limiter:gpt-4</code> 的信号量，并把它的总许可数（车位总数）设置为 <code>5</code>。这个操作只能成功一次。</p>
</li>
<li>
<p><strong>Redisson 底层操作</strong>：它不会傻傻地直接 <code>SET</code> 一个值。为了防止多个服务实例同时初始化导致冲突（竞态条件），它会向 Redis 发送一个类似 <code>SETNX</code> (SET if Not eXists) 的命令。</p>
<p><strong><code>SETNX &quot;ai:limiter:gpt-4&quot; 5</code></strong></p>
<p>这个 Redis 命令是<strong>原子性</strong>的。它表示：“只有当 <code>ai:limiter:gpt-4</code> 这个键<strong>不存在</strong>的时候，才将它设置为5”。</p>
<ul>
<li>
<p>第一个到达的实例执行 <code>SETNX</code>，成功设置了值，Redis 返回 <code>1</code>。</p>
</li>
<li>
<p>后面紧跟着到达的其他实例再执行 <code>SETNX</code>，发现键已经存在了，操作失败，Redis 返回 <code>0</code></p>
</li>
</ul>
<p>这样就完美保证了，无论多少个服务实例同时启动，这个信号量的总数只会被正确地初始化一次。</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2获取许可">2、获取许可<a href="#2获取许可" class="hash-link" aria-label="2、获取许可的直接链接" title="2、获取许可的直接链接">​</a></h4>
<p>这是最关键的一步，也是最能体现 Lua 脚本威力的地方。</p>
<ul>
<li>
<p><strong>开发者意图</strong>：我想从 <code>ai:limiter:gpt-4</code> 这个信号量里申请一个许可。如果当前许可数大于0，就给我一个，并把总数减一；如果等于0，就直接告诉我失败。整个过程必须是<strong>一步完成</strong>的，不能被打断。</p>
</li>
<li>
<p><strong>为什么不能用多个 Redis 命令？</strong> 如果你先用 <code>GET</code> 命令获取当前值，在你的应用代码里判断 <code>if (value &gt; 0)</code>，然后再用 <code>DECR</code> 命令去减一。这个过程是<strong>非原子</strong>的。 在高并发下，可能发生这种情况：</p>
<ol>
<li>
<p>服务A <code>GET</code> 到值为 <code>1</code>。</p>
</li>
<li>
<p>服务B 也在同时 <code>GET</code> 到值为 <code>1</code>。</p>
</li>
<li>
<p>服务A 判断 <code>1 &gt; 0</code> 成立，执行 <code>DECR</code>，值变为 <code>0</code>。</p>
</li>
<li>
<p>服务B 也判断 <code>1 &gt; 0</code> 成立，执行 <code>DECR</code>，值变为 <code>-1</code>。 结果，明明只有一个许可，却有两个服务同时获取成功，限流被“击穿”了。</p>
</li>
</ol>
</li>
<li>
<p><strong>Redisson 的 Lua 脚本解决方案</strong>： Redisson 会将“检查并减少”这个逻辑，编写成一个 Lua 脚本，然后通过 <code>EVAL</code> 命令一次性发给 Redis 去执行。Redis 会保证整个脚本的执行过程是<strong>原子</strong>的，不会被任何其他命令插入。</p>
<p>这个 Lua 脚本的逻辑可以简化成这样：</p>
</li>
</ul>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-- 脚本的参数：KEYS[1] 是信号量的键名, ARGV[1] 是想获取的许可数(通常是1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local key = KEYS[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local permitsToAcquire = tonumber(ARGV[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 从 Redis 中获取当前许可数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local availablePermits = tonumber(redis.call(&#x27;get&#x27;, key))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 如果还有足够的许可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if availablePermits and availablePermits &gt;= permitsToAcquire then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 减少许可数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis.call(&#x27;decrby&#x27;, key, permitsToAcquire)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 返回1代表成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 许可数不够，返回0代表失败</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3释放许可">3、释放许可<a href="#3释放许可" class="hash-link" aria-label="3、释放许可的直接链接" title="3、释放许可的直接链接">​</a></h4>
<p>释放许可相对简单。</p>
<ul>
<li>
<p><strong>开发者意图</strong>：我用完了一个许可，现在要把它还给 <code>ai:limiter:gpt-4</code>。</p>
</li>
<li>
<p><strong>Redisson 底层操作</strong>：同样是通过 Lua 脚本（或者一个简单的 <code>INCR</code> 命令）来完成。</p>
<p><strong><code>INCR &quot;ai:limiter:gpt-4&quot;</code></strong></p>
<p><code>INCR</code> 命令也是原子的，它会安全地将键的值加一。所以，释放操作同样不会有并发问题。</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="上面是redisson-进行令牌桶的操作的部分现在我要记录flux的使用">上面是Redisson 进行令牌桶的操作的部分，现在我要记录Flux的使用。<a href="#上面是redisson-进行令牌桶的操作的部分现在我要记录flux的使用" class="hash-link" aria-label="上面是Redisson 进行令牌桶的操作的部分，现在我要记录Flux的使用。的直接链接" title="上面是Redisson 进行令牌桶的操作的部分，现在我要记录Flux的使用。的直接链接">​</a></h2>
<p>代码的核心是 <code>Flux.using()</code>，你可以把它理解成是 Java 传统 <code>try-with-resources</code> 语句的<strong>响应式、异步版本</strong>。它的设计哲学是“<strong>借资源 -&gt; 用资源 -&gt; 还资源</strong>”，并确保“还资源”这一步<strong>无论如何都会被执行</strong>，从而防止资源泄漏。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1借资源">1、借资源<a href="#1借资源" class="hash-link" aria-label="1、借资源的直接链接" title="1、借资源的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> acquired </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">checkRateLimit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">modelKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> aiModelStragety</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">acquired</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">BusinessException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">REQUEST_TIMEOUT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;限流令牌已获取...&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> modelKey</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li>
<p><strong>作用</strong>：这是整个流程的入口。当有订阅者（subscriber）订阅这个 <code>Flux</code> 时，这个函数会被<strong>首先调用</strong>。</p>
</li>
<li>
<p><strong>具体行为</strong>：</p>
<ul>
<li>
<p>它调用 <code>checkRateLimit()</code> 去 Redisson 申请一个信号量许可（令牌）。</p>
</li>
<li>
<p><strong>申请成功</strong>：如果 <code>acquired</code> 为 <code>true</code>，它会记录一条日志，并返回 <code>modelKey</code> 作为“已成功获取的资源”的凭证。这个凭证会被传递给后续的两个函数。</p>
</li>
<li>
<p><strong>申请失败</strong>：如果 <code>acquired</code> 为 <code>false</code>（被限流了），它会立即抛出一个 <code>BusinessException</code> 异常。这个异常会使整个 <code>Flux</code> 流直接进入 <code>error</code> 状态，后续的“用资源”（<code>callModel</code>）和“还资源”逻辑都不会执行，流程提前终止。</p>
</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2用资源">2、用资源<a href="#2用资源" class="hash-link" aria-label="2、用资源的直接链接" title="2、用资源的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">acquiredResource </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> aiModelStragety</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">callModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">aiMessageDTO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fullPrompt</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<ul>
<li>
<p><strong>作用</strong>：只有在“借资源”成功后，这个函数才会被调用。它负责创建真正的业务数据流。</p>
</li>
<li>
<p><strong>具体行为</strong>：</p>
<ul>
<li>
<p>它接收上一步返回的资源凭证（令牌） <code>acquiredResource</code>（在这里就是<code>modelKey</code>）。</p>
</li>
<li>
<p>然后调用 <code>aiModelStragety.callModel()</code>，这个方法会返回一个 <code>Flux&lt;String&gt;</code>，也就是从 AI 模型那里流式返回的数据。这部分是整个业务逻辑的核心。</p>
</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="还资源">还资源<a href="#还资源" class="hash-link" aria-label="还资源的直接链接" title="还资源的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">releasedResource </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">String</span><span class="token plain"> limiterKey </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">AI_MODEL_LIMITER_KEY_SUFFIX</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> releasedResource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">RSemaphore</span><span class="token plain"> semaphore </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> redissonClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSemaphore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">limiterKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">semaphore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isExists</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        semaphore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">release</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;限流器已释放: key={}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> limiterKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">warn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;限流器不存在，无法释放: key={}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> limiterKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span></code></pre></div></div>
<ul>
<li>
<p><strong>作用</strong>：这是 <code>Flux.using</code> 最重要的保障机制。这个函数会在第二步创建的流<strong>终止时被调用</strong>。</p>
</li>
<li>
<p><strong>触发时机</strong>：无论流是正常结束、发生错误还是被取消，它<strong>必定会执行</strong>。</p>
<ul>
<li>
<p><strong>正常完成 (<code>onComplete</code>)</strong>：AI 模型成功返回了所有数据。</p>
</li>
<li>
<p><strong>发生错误 (<code>onError</code>)</strong>：在调用 <code>callModel</code> 的过程中发生了任何异常。</p>
</li>
<li>
<p><strong>被取消 (<code>onCancel</code>)</strong>：下游的调用者取消了数据订阅。</p>
</li>
</ul>
</li>
<li>
<p><strong>具体行为</strong>：它接收到凭证，然后调用 <code>semaphore.release(1)</code>，将之前申请的那个许可<strong>归还</strong>给 Redisson 的信号量池。这就确保了限流的许可能够被可靠地回收，不会发生“只借不还”的资源泄漏问题。</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="doonerror">.doOnError<a href="#doonerror" class="hash-link" aria-label=".doOnError的直接链接" title=".doOnError的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">doOnError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">throwable </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 只有当 callModel 内部发生错误时才会记录，限流错误在 using 内部处理  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">throwable </span><span class="token keyword" style="color:#00009f">instanceof</span><span class="token plain"> </span><span class="token class-name">BusinessException</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BusinessException</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> throwable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getErrorCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">equals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">REQUEST_TIMEOUT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;AI模型调用失败: modelKey={}, error={}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> modelKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> throwable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>这是一个“副作用”操作符，它允许你在不改变流的情况下，对流中的错误信号进行一些处理。</p>
<ul>
<li>
<p><strong>作用</strong>：它在这里的作用是记录日志。</p>
</li>
<li>
<p><strong>精妙之处</strong>：它加了一个判断 <code>if (!(throwable instanceof BusinessException &amp;&amp; ...))</code>，意思是<strong>只记录那些不是因为限流（REQUEST_TIMEOUT）而发生的未知错误</strong>。因为限流是一个预期的、正常的业务逻辑，已经在第一步中记录过了，没必要再当作一个意外错误来重复记录，这样可以保持日志的整洁和有效性。</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="为什么必须用-fluxusing">为什么必须用 <code>Flux.using</code>？<a href="#为什么必须用-fluxusing" class="hash-link" aria-label="为什么必须用-fluxusing的直接链接" title="为什么必须用-fluxusing的直接链接">​</a></h2>
<p>AI模型调用是<strong>异步流式</strong>的，即 <code>callModel(...)</code> 方法返回的是 <code>Flux&lt;String&gt;</code>。这是一个关键点。</p>
<p><code>Flux</code> 代表的是一个“未来的数据序列”，调用 <code>callModel</code> 方法会<strong>立即返回</strong>，而数据（AI的回答）会在之后的某个时间点，以数据流的形式陆续到达。</p>
<ul>
<li>
<p><strong>如果不用 <code>Flux.using</code></strong>（比如尝试手动管理许可）：</p>
<ul>
<li>
<p>你会遇到一个棘手的问题：<strong>应该在什么时候调用 <code>semaphore.release()</code> 来释放许可？</strong></p>
</li>
<li>
<p><strong>错误做法1：在 <code>callModel</code> 调用后立即释放。</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 绝对错误！</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">semaphore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">acquire</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Flux</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> resultStream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aiModelStragety</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">callModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">semaphore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">release</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 大BUG！此时AI调用刚开始，许可就被释放了！</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> resultStream</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
</li>
</ul>
</li>
</ul>
<p>这会导致许可被瞬间释放，下一个请求马上就能获得许可，并发控制形同虚设。</p>
<ul>
<li><strong>错误做法2：尝试使用回调。</strong></li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">semaphore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">acquire</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> aiModelStragety</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">callModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">doOnTerminate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 当流终止时（完成或错误）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            semaphore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">release</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">doOnCancel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 当流被取消时</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            semaphore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">release</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>这种方式虽然可行，但非常笨拙。你需要手动处理所有可能的终止情况（<code>onComplete</code>, <code>onError</code>, <code>onCancel</code>），代码可读性差，容易遗漏，这就是所谓的“回调地狱”，不是一种健壮的设计。</p>
<ul>
<li><strong><code>Flux.using</code> 的作用</strong>：<!-- -->
<ul>
<li>它就是为了解决这个**“异步资源生命周期管理”**问题而生的。</li>
<li>它将**“获取资源”<strong>（<code>acquire</code>）、</strong>“使用资源创建流”<strong>（<code>callModel</code>）、</strong>“释放资源”**（<code>release</code>）这三个步骤优雅地绑定在了一起。</li>
<li>它向你保证：<strong>无论中间的异步流是正常完成、发生错误、还是被中途取消，那个“释放资源”的逻辑都一定会被执行。</strong></li>
</ul>
</li>
</ul>
<p><strong>所以，<code>Flux.using</code> 回答了这个问题：对于一个异步数据流，我如何能100%确保我之前获取的资源，在流程结束后一定被释放？</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="补充知识">补充知识：<a href="#补充知识" class="hash-link" aria-label="补充知识：的直接链接" title="补充知识：的直接链接">​</a></h2>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="flux-的底层是什么">Flux 的底层是什么？<a href="#flux-的底层是什么" class="hash-link" aria-label="Flux 的底层是什么？的直接链接" title="Flux 的底层是什么？的直接链接">​</a></h4>
<p><code>Flux</code> 是 Project Reactor 库中的核心类之一，而 Project Reactor 是实现<strong>响应式编程规范（Reactive Streams Specification）</strong> 的一个主流框架。</p>
<p>Flux 的底层核心思想可以概括为以下几点：</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1响应式编程是基于经典的发布者-订阅者设计模式的">1、响应式编程是基于经典的<strong>发布者-订阅者</strong>设计模式的。<a href="#1响应式编程是基于经典的发布者-订阅者设计模式的" class="hash-link" aria-label="1响应式编程是基于经典的发布者-订阅者设计模式的的直接链接" title="1响应式编程是基于经典的发布者-订阅者设计模式的的直接链接">​</a></h5>
<ul>
<li><strong><code>Flux</code> (或 <code>Mono</code>) 是发布者 (Publisher)</strong>：它代表一个包含 0 到 N 个元素的<strong>异步数据序列</strong>。你可以把它想象成一个“数据管道”，它只用来传输经过他的数据（这些数据可以来自数据库，定时任务的生产，取决于你怎么生产这些数据），本身不产生数据。</li>
<li></li>
</ul>
<p><strong>我们的代码中是发布者呢</strong>？</p>
<p><strong>发布者</strong>就是你通过 <code>Flux.using(...)</code>精心构建并从 <code>invokeAiModel</code> 方法<strong>返回</strong>的那个 <code>Flux&lt;String&gt;</code> 对象。</p>
<p>它不仅仅是一个简单的数据源，而是一个<strong>复合的、智能的数据管道</strong>。这个管道的蓝图（定义）包含了：</p>
<ol>
<li>
<p><strong>前置操作逻辑</strong>：在数据开始流动前，必须先从 Redisson 获取一个限流许可。</p>
</li>
<li>
<p><strong>核心数据源</strong>：真正的数据来自于 <code>aiModelStragety.callModel(...)</code> 返回的另一个 <code>Flux</code>。</p>
</li>
<li>
<p><strong>后置清理逻辑</strong>：无论数据流是正常结束、出错还是被取消，都必须归还 Redisson 的许可。</p>
</li>
</ol>
<p>所以，这个由 <code>Flux.using(...)</code> 创造的 <code>Flux&lt;String&gt;</code> 就是一个功能完备的<strong>发布者</strong>。它已经准备好，一旦有人订阅，它就知道该如何一步步地执行上述所有操作。</p>
<hr>
<ul>
<li>
<p>**调用 <code>.subscribe(...)</code> 的是你写的逻辑，它代表你定义的订阅者（Subscriber）角色，负责对数据流进行消费。**在响应式编程模型中，<code>subscribe()</code> 是触发整个数据流的关键操作。只有在订阅发生时，Flux 或 Mono 才会开始执行你预先定义的数据生成、转换与传递逻辑（即“惰性求值”特性）。这个订阅者可以是你自己实现的回调函数，也可以是框架中预定义的消费者，例如用于响应式 Web 请求、数据库响应等场景。</p>
</li>
<li>
<p><strong>“没有订阅，就没有事件”</strong>：这是响应式编程的黄金法则。你定义了一长串的 <code>Flux</code> 操作（如 <code>map</code>, <code>filter</code>, <code>using</code>），但只要没有最终的 <code>.subscribe()</code> 调用，整个数据流就不会启动。</p>
</li>
</ul>
<p><strong>谁是订阅者</strong> (Subscriber)？</p>
<p>可能会疑惑，在<code>invokeAiModel</code> 方法里，并没有看到任何 <code>.subscribe()</code> 的调用。这是因为在现代响应式框架（比如正在使用的 <strong>Spring WebFlux</strong>）中，最终的订阅操作通常是由<strong>框架本身</strong>来完成的。</p>
<p>我把调用的接口放在这里：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@GetMapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;invoke&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> produces </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">MediaType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">TEXT_PLAIN_VALUE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">ResponseEntity</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Flux</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">invokeAiModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@RequestParam</span><span class="token plain"> </span><span class="token class-name">Long</span><span class="token plain"> jobId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:#393A34">@RequestParam</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> prompt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Flux</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aiModelService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">invokeAiModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jobId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prompt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">ResponseEntity</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">contentType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MediaType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">TEXT_PLAIN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">body</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>订阅的“魔法”就发生在这里：</strong></p>
<ol>
<li>
<p>一个外部客户端（比如网页）向 <code>/ai/stream-invoke</code> 发起了一个 HTTP 请求。</p>
</li>
<li>
<p>Spring WebFlux 框架接收到请求，并调用你的 <code>streamInvoke</code> 控制器方法。</p>
</li>
<li>
<p>你的方法返回了一个 <code>Flux&lt;String&gt;</code> 对象（那个<strong>发布者</strong>）。</p>
</li>
<li>
<p><strong>关键时刻</strong>：Spring WebFlux 框架接管了这个返回的 <code>Flux</code>。它看到返回值是一个响应式类型，于是<strong>框架自己扮演了订阅者的角色，并在内部对你的 <code>Flux</code> 调用了 <code>.subscribe()</code></strong>。</p>
</li>
</ol>
<p>这个由 <strong>Spring WebFlux 框架</strong>创建的<strong>订阅者</strong>，它的任务是专门<strong>处理 HTTP 响应</strong>。它的逻辑大致如下：</p>
<ul>
<li>
<p>当接收到 <code>onNext(String data)</code> 信号时（即AI模型传来一小块数据）：它会将这块数据写入到 HTTP 的响应体中，实时地发送给客户端。这就是流式响应（Server-Sent Events）的实现方式。</p>
</li>
<li>
<p>当接收到 <code>onError(Throwable error)</code> 信号时（比如你的限流异常或者模型调用失败）：它会将这个异常转换成一个合适的 HTTP 错误状态码（比如 429 Too Many Requests 或 500 Internal Server Error）并返回给客户端。</p>
</li>
<li>
<p>当接收到 <code>onComplete()</code> 信号时（AI数据流正常结束）：它会正常地关闭 HTTP 响应连接。</p>
</li>
</ul>
<hr>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="2-基于推的异步模型-push-based-asynchronous-model">2 基于“推”的异步模型 (Push-based Asynchronous Model)<a href="#2-基于推的异步模型-push-based-asynchronous-model" class="hash-link" aria-label="2 基于“推”的异步模型 (Push-based Asynchronous Model)的直接链接" title="2 基于“推”的异步模型 (Push-based Asynchronous Model)的直接链接">​</a></h5>
<ul>
<li>
<p><strong>传统模型（Pull 拉模式）</strong>：像 <code>Iterator</code> 或 <code>List</code>，是消费者主动去拉取数据 (<code>iterator.next()</code>)，如果数据还没准备好，线程就会<strong>阻塞</strong>等待。</p>
</li>
<li>
<p><strong>响应式模型（Push 推模式）</strong>：是生产者（Publisher）在数据准备好后，<strong>主动推送</strong>给消费者（Subscriber）。整个过程是<strong>异步非阻塞</strong>的，线程不需要空闲等待，可以去处理其他任务，大大提高了系统资源的利用率。</p>
</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3-事件信号-event-signals">3. 事件信号 (Event Signals)<a href="#3-事件信号-event-signals" class="hash-link" aria-label="3. 事件信号 (Event Signals)的直接链接" title="3. 事件信号 (Event Signals)的直接链接">​</a></h5>
<p><code>Flux</code> 数据流中传递的不仅仅是数据，而是一系列<strong>标准化的事件信号</strong>：</p>
<ul>
<li>
<p><code>onNext(T data)</code>: 推送一个正常的数据项。</p>
</li>
<li>
<p><code>onComplete()</code>: 通知订阅者数据流已成功结束，不会再有 <code>onNext</code> 事件。</p>
</li>
<li>
<p><code>onError(Throwable error)</code>: 通知订阅者流中发生了错误，数据流异常终止。</p>
</li>
</ul>
<p><code>Flux.using</code> 的三个函数，本质上就是在响应这三种信号（<code>onNext</code> 由 <code>callModel</code> 的 <code>Flux</code> 产生，<code>onComplete</code>/<code>onError</code> 会触发资源清理）。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="4-背压-backpressure">4. 背压 (Backpressure)<a href="#4-背压-backpressure" class="hash-link" aria-label="4. 背压 (Backpressure)的直接链接" title="4. 背压 (Backpressure)的直接链接">​</a></h5>
<p>这是响应式流最关键、最复杂的概念之一。它解决了“快生产者 vs 慢消费者”的问题。</p>
<ul>
<li>
<p><strong>问题</strong>：如果数据生产者（如一个快速的数据库）推送数据的速度远远快于消费者处理的速度，会导致消费者内存溢出而崩溃。</p>
</li>
<li>
<p><strong>解决方案</strong>：订阅者在订阅时，会通过一个 <code>Subscription</code> 对象告诉发布者：“我准备好了，请先给我 N 个元素”（<code>subscription.request(N)</code>）。发布者只会推送 N 个元素，然后等待订阅者下一次的 <code>request</code> 请求。这给予了消费者反向控制流量的能力，防止自己被冲垮。</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="semaphore-信号量在java中的作用"><strong>Semaphore 信号量在Java中的作用:</strong><a href="#semaphore-信号量在java中的作用" class="hash-link" aria-label="semaphore-信号量在java中的作用的直接链接" title="semaphore-信号量在java中的作用的直接链接">​</a></h4>
<p>在Java中，<code>Semaphore</code>（信号量）是 <code>java.util.concurrent</code> 并发包提供的一个非常重要的工具类。它的核心作用是<strong>控制对特定资源或代码块的同时访问的线程数量</strong>。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="主要方法和特性总结">主要方法和特性总结<a href="#主要方法和特性总结" class="hash-link" aria-label="主要方法和特性总结的直接链接" title="主要方法和特性总结的直接链接">​</a></h5>
<ol>
<li>
<p><strong>构造函数</strong>：</p>
<ul>
<li>
<p><code>Semaphore(int permits)</code>：创建一个具有指定许可数量的信号量。</p>
</li>
<li>
<p><code>Semaphore(int permits, boolean fair)</code>：可以指定是否为“公平模式”。公平模式下，等待的线程会按照 FIFO（先进先出）的顺序获得许可。非公平模式则允许“插队”，性能通常更高。</p>
</li>
</ul>
</li>
<li>
<p><strong>核心方法</strong>：</p>
<ul>
<li>
<p><code>void acquire()</code>: 获取一个许可，如果没有可用许可，则<strong>阻塞</strong>等待。</p>
</li>
<li>
<p><code>void release()</code>: 释放一个许可，使其返回信号量。</p>
</li>
<li>
<p><code>boolean tryAcquire()</code>: <strong>非阻塞</strong>地尝试获取一个许可。如果成功，返回 <code>true</code>；如果失败（没有可用许可），立即返回 <code>false</code>，线程不会等待。</p>
</li>
<li>
<p><code>int availablePermits()</code>: 返回当前可用的许可数量。</p>
</li>
</ul>
</li>
<li>
<p><strong>关键特性</strong>：</p>
<ul>
<li>
<p><strong>作用范围：单个 JVM</strong>。Java 的 <code>Semaphore</code> 只能控制<strong>同一个Java进程内部</strong>的线程。它无法像 Redisson 的 <code>RSemaphore</code> 那样跨越多个服务器进行分布式协调。</p>
</li>
<li>
<p>**用途：它主要有两种工作模式：</p>
<ul>
<li><strong>作为互斥锁 (<code>new Semaphore(1)</code>)</strong>：当许可数设置为1时，信号量的作用等同于一个锁，可以确保代码块在任何时刻最多只有一个线程执行，从而保护共享数据，保证线程安全。</li>
<li><strong>作为流量控制器 (<code>new Semaphore(N)</code>)</strong>：当许可数设置为N（N &gt; 1）时，它允许多达N个线程并发访问。这通常不用于保护共享变量，而是用于管理有限的资源池，如数据库连接、或限制对某个API的并发调用次数。</li>
</ul>
</li>
</ul>
</li>
</ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/DHxingxing/obsidian/edit/main/docs/Iflytek/技术方案/Ai大模型调用时候Redission实现的令牌桶限流.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/obsidian/docs/Iflytek/工作计划"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">工作计划</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/obsidian/docs/Iflytek/技术方案/Java通过WebSocket 与AI进行通信"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Java通过WebSocket 与AI进行通信</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1策略工厂替换原来的名称匹配" class="table-of-contents__link toc-highlight">1、策略工厂替换原来的名称匹配</a></li><li><a href="#2redission-实现令牌桶限流" class="table-of-contents__link toc-highlight">2、Redission 实现令牌桶限流</a></li><li><a href="#上面是redisson-进行令牌桶的操作的部分现在我要记录flux的使用" class="table-of-contents__link toc-highlight">上面是Redisson 进行令牌桶的操作的部分，现在我要记录Flux的使用。</a></li><li><a href="#为什么必须用-fluxusing" class="table-of-contents__link toc-highlight">为什么必须用 <code>Flux.using</code>？</a></li><li><a href="#补充知识" class="table-of-contents__link toc-highlight">补充知识：</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/obsidian/docs/intro">快速开始</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/obsidian/blog">博客</a></li><li class="footer__item"><a href="https://github.com/DHxingxing/obsidian" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 DHxingxing. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>